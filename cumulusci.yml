minimum_cumulusci_version: "3.12.2"
project:
  name: cci-tasks
  package:
    name: cci-tasks
    api_version: "48.0"
  source_format: sfdx

sources:
  npsp:
    github: https://github.com/SalesforceFoundation/NPSP
    release: latest

tasks:
  resolve_dependencies:
    description: Transfers cci dependencies to sfdx-project.json
    class_path: tasks.ResolveDependencies

  set_default:
    description: Changes the default directory. Pass in directory with -o
    class_path: tasks.SetDefault

  init_rollup_settings:
    description: Initialize rollup settings, since the custom_settings_value_wait task requires the value to exist.
    class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
    group: NPSP
    options:
      apex: >
        npsp__Customizable_Rollup_Settings__c crlpSettings = npsp__Customizable_Rollup_Settings__c.getOrgDefaults();
        upsert crlpSettings;

  npsp_custom_config:
    description: Post install metadata for NNPSP
    class_path: cumulusci.tasks.salesforce.Deploy
    group: Salesforce Metadata
    options:
      path: unpackaged/npsp/custom_config

  generate_test_data:
    description: Creates a new set of test data; overwrites existing data file.
    class_path: tasks.data.CreateTestData
    group: Test Data
    options:
      sql_path: datasets/dev_org/test_data.sql

  test_data_dev_org:
    description: Loads a test data set for most NPSP objects based on 100 Contacts that should fit into a scratch org or DE org.
    class_path: cumulusci.tasks.bulkdata.LoadData
    group: Test Data
    options:
      sql_path: datasets/dev_org/test_data.sql
      mapping: datasets/mapping.yml
      ignore_row_errors: true

  test_data_delete:
    description: Deletes all data in the objects specified in the objects option.
    class_path: cumulusci.tasks.bulkdata.DeleteData
    group: Test Data
    options:
      objects:
        - npsp__Allocation__c
        - OpportunityContactRole
        - Opportunity
        - npe03__Recurring_Donation__c
        - Case
        - npsp__General_Accounting_Unit__c
        - Campaign
        - CampaignMember
        - npsp__Address__c
        - Contact
        - Account

  dx_install_historical_transactions_authorize:
    description: Install Historical Transactions unmanaged package from CANDTECH Org
    class_path: cumulusci.tasks.sfdx.SFDXOrgTask
    options:
      command: force:package:install
      extra: -p 04tj0000001acCZ --noprompt --wait 300

  tracking_clear:
    description: Resets the tracking status.
    class_path: cumulusci.tasks.sfdx.SFDXOrgTask
    options:
      command: "force:source:tracking:clear"
      extra: "-p"

  tracking_reset:
    description: Resets the tracking status.
    class_path: cumulusci.tasks.sfdx.SFDXOrgTask
    options:
      command: "force:source:tracking:reset"
      extra: "-p"

  pull_custom_settings:
    description: Pulls custom settings from org into orgCustomSettings.yml
    class_path: tasks.pullCustomSettings.PullSettings

flows:
  import_test_data:
    steps:
      1:
        task: test_data_delete
      2:
        task: generate_test_data
      3:
        task: test_data_dev_org

  tracking_reset:
    steps:
      1:
        task: tracking_clear
      2:
        task: tracking_reset
        
  push_custom_settings:
        steps:
            1:
                task: load_custom_settings
                options:
                    settings_path: orgCustomSettings.yml